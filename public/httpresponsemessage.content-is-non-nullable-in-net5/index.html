<!DOCTYPE html>
<html lang="en-US">
<head>

    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    
    
        <meta name="twitter:card" content="summary"/>
    



<meta name="twitter:title" content="HttpResponseMessage.Content is non-nullable in NET5"/>
<meta name="twitter:description" content="Today I learned the hard way that NET5 changed the HttpResponseMessage.Content type from nullable to non-nullable"/>
<meta name="twitter:site" content="@"/>



  	<meta property="og:title" content="HttpResponseMessage.Content is non-nullable in NET5 &middot; Nicola Iarocci" />
  	<meta property="og:site_name" content="Nicola Iarocci" />
  	<meta property="og:url" content="https://nicolaiarocci.com/httpresponsemessage.content-is-non-nullable-in-net5/" />

    
        
    

    
    <meta property="og:description" content="Today I learned the hard way that NET5 changed the HttpResponseMessage.Content type from nullable to non-nullable" />
  	<meta property="og:type" content="article" />
    <meta property="article:published_time" content="2020-12-04T07:05:25&#43;01:00" />

    
    

    <title>HttpResponseMessage.Content is non-nullable in NET5 &middot; Nicola Iarocci</title>

    
    <meta name="description" content="Today I learned the hard way that NET5 changed the HttpResponseMessage.Content type from nullable to non-nullable" />
    

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="/images/favicon.ico">
	  <link rel="apple-touch-icon" href="/images/apple-touch-icon.png" />

    <link rel="stylesheet" type="text/css" href="/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="/css/nav.css" />

    
    <link rel="stylesheet" href="/css/custom.css">
    

    

    
      
          <link href="/index.xml" rel="alternate" type="application/rss+xml" title="Nicola Iarocci" />
      
      
    
    <meta name="generator" content="Hugo 0.55.4" />

    <link rel="canonical" href="https://nicolaiarocci.com/httpresponsemessage.content-is-non-nullable-in-net5/" />

    
      
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name":  null 
    },
    "author": {
        "@type": "Person",
        "name":  null ,
        
        "url": "https://nicolaiarocci.com",
        "sameAs": [
            
            
             
             
             
             
             
            
        ]
    },
    "headline": "HttpResponseMessage.Content is non-nullable in NET5",
    "name": "HttpResponseMessage.Content is non-nullable in NET5",
    "wordCount":  378 ,
    "timeRequired": "PT2M",
    "inLanguage": {
      "@type": "Language",
      "alternateName": "en"
    },
    "url": "https://nicolaiarocci.com/httpresponsemessage.content-is-non-nullable-in-net5/",
    "datePublished": "2020-12-04T07:05Z",
    "dateModified": "2020-12-04T07:05Z",
    
    
    "description": "Today I learned the hard way that NET5 changed the HttpResponseMessage.Content type from nullable to non-nullable",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://nicolaiarocci.com/httpresponsemessage.content-is-non-nullable-in-net5/"
    }
}
    </script>
    


    

    
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-19006041-1', 'auto');
      ga('send', 'pageview');

    </script>
    

    
</head>
<body class="nav-closed">

  <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        
        
        
            
            <li class="nav-opened" role="presentation">
            	<a href="/">Blog</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
            	<a href="/about">About</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
            	<a href="/opensource">Open Source</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
            	<a href="/talks">Speaking</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
            	<a href="/books-i-have-read">Reading</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
            	<a href="/il-piccolo-libro-di-mongodb-edizione-italiana">MongoDB</a>
            </li>
        
            <h3>Subscribe</h3>
            <li class="nav-opened" role="presentation">
            	<a href="http://eepurl.com/b-_Pzz">New posts via mail</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
            	<a href="https://nicolaiarocci.com/index.xml">RSS feed</a>
            </li>
        
            <h3>Follow me</h3>
            <li class="nav-opened" role="presentation">
            	<a href="https://twitter.com/nicolaiarocci">Twitter</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
            	<a href="https://github.com/nicolaiarocci">Github</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
            	<a href="https://stackoverflow.com/users/323269/nicola-iarocci?tab=profile">Stack Overflow</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
            	<a href="http://speakerdeck.com/u/nicola">Speaker Deck</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
            	<a href="http://www.linkedin.com/in/nicolaiarocci">LinkedIn</a>
            </li>
        
        
    </ul>

    
    <a class="subscribe-button icon-feed" href="/index.xml">Subscribe</a>
    
</div>
<span class="nav-cover"></span>


 <div class="site-wrapper">



<header class="main-header post-head no-cover">
  <nav class="main-nav clearfix">


  
  
      <a class="menu-button" href="#"><span class="burger">&#9776;</span><span class="word">Menu</span></a>
  
  </nav>
</header>



<main class="content" role="main">




  <article class="post post">

    <header class="post-header">
        <h1 class="post-title">HttpResponseMessage.Content is non-nullable in NET5</h1>
        <small>Today I learned the hard way that NET5 changed the HttpResponseMessage.Content type from nullable to non-nullable</small>

        <section class="post-meta">
        
          <time class="post-date" datetime="2020-12-04T07:05:25&#43;01:00">
            Dec 4, 2020
          </time>
        
         
        </section>
    </header>

    <section class="post-content">
      <p>Today I was happily migrating some C# projects to Net 5 when I stumbled upon
something unexpected. My focus was on a library (a NetStandard2.0 REST API
client, an SDK) and its associated test suite. The test project was a NetCore
3.1 application.</p>

<p>As you can imagine, being a REST API client, the library does a lot of talking
with a remote Web Service. It does that by leveraging the almightly
<code>System.Net.HttpClient.</code> The library has a private, static
<code>HttpResponseMessage</code> parser method. Its job is, well, to parse all responses
from the remote. It looks for known, expected headers, gracefully handle them,
and then deserializes the response content, if there is any.</p>

<p>The test suite has one primary task: to ensure that the SDK can adequately
handle the request-response cycle. It does that by mocking
a <code>HttpMessageHandler,</code> which is then used by the library HttpClient on every
test run.</p>

<p>Until this morning, all 239 tests were passing just fine. Then, I switched the
test project&rsquo;s target framework moniker (TFM) to <code>net5.0</code>. Suddenly, most tests
went red.</p>

<p>With no code changes, only a rebuild after the TFM switch, I knew I was up
to something weird.</p>

<p>A couple of debug breakpoints later, I was back looking at my little response
parser, contemplating the following, rather innocent-looking line:</p>

<pre><code>if (httpResponseMessage.Content == null) return (response, token);
</code></pre>

<p>Its purpose is to skip deserialization if there no content in the response.
I knew all the failing tests had no response content.</p>

<p>When the caller (the test suite in this case) is a NetCore 3.1 application, it
passes a <code>HttpResponseMessage</code> whose <code>Content</code> value is null, as expected.
Instead, it appears that when a NET5 application invokes the same method, the
<code>HttpResponseMessage.Content</code> carries an obscure <code>EmtpyContent</code> value.
Unexpected and, more importantly, undocumented (at least to my knowledge<sup class="footnote-ref" id="fnref:1"><a href="#fn:1">1</a></sup>.)</p>

<p>A not-so-quick investigation revealed that, in fact, sometime during the NET5
development process, the type of <code>HttpResponseMessage.Content</code> has changed from
nullable to non-nullable<sup class="footnote-ref" id="fnref:2"><a href="#fn:2">2</a></sup>.</p>

<pre><code>if (httpResponseMessage.Content == null || 
    httpResponseMessage.Content.Headers.ContentLength == 0)
    return response;
</code></pre>

<p>The double condition makes sure that no matter the calling moniker, we&rsquo;ll
handle it just fine.</p>

<p>There we go. All tests are green again.</p>

<p><em>Enjoyed this post? Subscribe to the <a href="http://eepurl.com/b-_Pzz">newsletter</a> or follow @<a href="http://twitter.com/nicolaiarocci">nicolaiarocci</a> on Twitter.</em></p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:1"><a href="https://docs.microsoft.com/en-us/dotnet/core/compatibility/5.0">Breaking changes in .NET 5.0</a>
 <a class="footnote-return" href="#fnref:1"><sup>[return]</sup></a></li>
<li id="fn:2"><a href="https://github.com/dotnet/runtime/pull/35910">Make HttpResponseMessage.Content non-nullable</a>
 <a class="footnote-return" href="#fnref:2"><sup>[return]</sup></a></li>
</ol>
</div>

    </section>


  <footer class="post-footer">


    









<section class="author">
  <h4><a href="https://nicolaiarocci.com/">Nicola Iarocci</a></h4>
  
  <p>Read <a href="https://nicolaiarocci.com/">more posts</a> by this author.</p>
  
  <div class="author-meta">
    <span class="author-location icon-location">Ravenna, Italy</span>
    <span class="author-link icon-link"><a href="https://nicolaiarocci.com">https://nicolaiarocci.com</a></span>
  </div>
</section>




    


    







  </footer>
</article>

</main>


  <aside class="read-next">
  
      <a class="read-next-story" style="no-cover" href="/five-good-books-i-read-in-2020/">
          <section class="post">
              <h2>Five good books I read in 2020</h2>
              
          </section>
      </a>
  
  
      <a class="read-next-story prev" style="no-cover" href="/events-and-callbacks-in-the-python-language/">
          <section class="post">
              <h2>Events and callbacks in the Python language</h2>
          </section>
      </a>
  
</aside>



    <footer class="site-footer clearfix">
        <section class="copyright"><a href="">Nicola Iarocci</a> All rights reserved</section>
        
    </footer>
    </div>
    <script type="text/javascript" src="/js/jquery.js"></script>
    <script type="text/javascript" src="/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/js/index.js"></script>
    
</body>
</html>

